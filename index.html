<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Intent</title>
  <link rel="stylesheet" href="style.css" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Intent" />
  <meta name="theme-color" content="#08090c" />
</head>

<body>
  <main class="container">

    <!-- Brand -->
    <header class="brand">
      <h1>Intent</h1>
      <div class="tagline">Screen discipline system</div>
    </header>

    <!-- ===================================================
         HERO ‚Äî Temps global + √©tat
    ==================================================== -->
    <section class="card hero" aria-label="Dashboard">
      <div class="heroTop">
        <div id="stateDot" class="stateDot" aria-hidden="true"></div>
        <div class="heroMain">
          <div class="heroValue">
            <span id="todayMinutes">0</span><span class="unit">min</span>
          </div>
          <div class="heroLabel">
            <span id="stateLabel">En contr√¥le</span>
          </div>
        </div>
      </div>

      <!-- Breakdown par app -->
      <div id="appBreakdown" class="appBreakdown"></div>
      <div id="streakBadge" class="streakBadge hidden"></div>
      <div id="dailySummary" class="dailySummary hidden"></div>
      <div id="autoCoachBanner" class="autoCoachBanner hidden">
        ‚ö†Ô∏è Tu as ouvert 3 fois sans intention claire aujourd'hui.
        <button onclick="window.UI.launchCoach()">Voir le coach ‚Üí</button>
      </div>

      <div class="kpis" aria-label="Indicateurs">
        <div class="kpi">
          <div class="kpiTitle">Tendance</div>
          <div id="kpiTrend" class="kpiValue">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpiTitle">Pression</div>
          <div id="kpiPressure" class="kpiValue">0/3</div>
        </div>
        <div class="kpi">
          <div class="kpiTitle">Auto (7j)</div>
          <div id="kpiAuto" class="kpiValue">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- ===================================================
         CONTROLS ‚Äî S√©lecteur d'app + lancer session
    ==================================================== -->
    <section id="menu" class="card" aria-label="Contr√¥le">
      <h2>Quelle app ?</h2>

      <!-- Grille de s√©lection des apps -->
      <div id="appSelector" class="appSelectorGrid" aria-label="Choisir une app">
        <!-- Rempli par ui.js -->
      </div>

      <button id="btnAllow" class="hidden" onclick="startSession(window._selectedApp)">
        S√©lectionne une app ci-dessus
      </button>

      <button onclick="launchCoach()" style="margin-top:10px;">
        Coach personnel
      </button>
    </section>

    <!-- ===================================================
         INTENT
    ==================================================== -->
    <section id="intentBlock" class="card hidden" aria-label="Intention">
      <h2>Pourquoi ouvrir cette app ?</h2>

      <button onclick="setIntentAndStart('reply')">
        R√©pondre √† quelqu'un
      </button>
      <button onclick="setIntentAndStart('fun')">
        Divertissement conscient
      </button>
      <button onclick="setIntentAndStart('auto')">
        Automatique / ennui
      </button>
      <button onclick="cancelIntent()" style="opacity:0.45; margin-top:16px; text-align:center;">
        Annuler
      </button>
    </section>

    <!-- ===================================================
         TIMER
    ==================================================== -->
    <section id="timer" class="card hidden" aria-label="Minuteur">
      <h2>Minuteur</h2>
      <div id="timeDisplay">‚Äî:‚Äî‚Äî</div>
      <p id="timerHint">Le raccourci iOS g√®re la session et renvoie le temps pass√©.</p>
    </section>

    <!-- ===================================================
         COACH
    ==================================================== -->
    <section id="coach" class="card hidden" aria-label="Coach personnel">
      <h2>Analyse coach</h2>

      <div class="coachMeta">
        <span id="coachRiskBadge" class="coachBadge badge-low">‚Äî</span>
        <span id="coachProfile" class="coachProfileLabel">‚Äî</span>
      </div>

      <div class="coachRecoLabel">Recommandation</div>
      <div id="coachRecommendation">Calcul en cours‚Ä¶</div>

      <div class="coachDivider"></div>

      <div id="coachActions" aria-label="Choix">
        <div class="coachActionsLabel">Je choisis</div>
        <button data-choice="primary" onclick="logChoice('primary')">
          T√¢che unique, t√©l√©phone hors pi√®ce
        </button>
        <button data-choice="alt1" onclick="logChoice('alt1')">
          Marche sans t√©l√©phone (10 min)
        </button>
        <button data-choice="alt2" onclick="logChoice('alt2')">
          Respiration 4/6 (5 min)
        </button>
      </div>

      <div id="outcomeBlock" class="hidden">
        <div class="coachActionsLabel" style="margin-top:16px;">R√©sultat</div>
        <button onclick="logOutcome('done')">J'ai fait l'action</button>
        <button onclick="logOutcome('partial')">Partiellement</button>
        <button onclick="logOutcome('ignored')">Je n'ai pas fait</button>
      </div>

      <button onclick="location.reload()" style="opacity:0.4; margin-top:20px; text-align:center;">
        Retour
      </button>
    </section>

    <!-- ===================================================
         DIAGNOSTIC
    ==================================================== -->
    <section id="stats" class="card" aria-label="Diagnostic">
      <h2>Diagnostic</h2>

      <!-- Onglets par app -->
      <div id="statsTabBar" class="statsTabBar" aria-label="Filtrer par app">
        <!-- Rempli par ui.js -->
      </div>

      <!-- Risk score -->
      <div class="riskHeader">
        <span id="riskScore" class="riskScore risk-low">‚Äî</span>
        <span class="riskScoreMax">/100</span>
        <span id="riskLine" class="riskTier tier-low">‚Äî</span>
      </div>

      <div class="riskbar" aria-label="Niveau de risque">
        <div id="riskBarFill" class="riskbar__fill" style="width:0%"></div>
      </div>

      <div id="riskChips" class="chips" aria-label="Raisons principales"></div>

      <p id="profileTraits"></p>

      <!-- Sessions du jour -->
      <details class="accordion" id="todayAccordion">
        <summary>Sessions du jour</summary>
        <div class="accordion__content">
          <div id="todaySessionsList"></div>
        </div>
      </details>

      <!-- Analyse 7 jours -->
      <details class="accordion">
        <summary>Analyse 7 jours</summary>
        <div class="accordion__content">
          <!-- S√©lecteur de jour -->
          <div id="chartDayPicker" class="chartDayPicker"></div>
          <canvas id="chart" width="340" height="200" style="width:100%;height:auto;"></canvas>
          <!-- Boutons de vue -->
          <div class="chartControls">
            <button id="chartToggle" class="chartToggleBtn" onclick="toggleChartMode()">Par intention</button>
          </div>
          <div id="prediction"></div>
          <div id="intentStats"></div>
        </div>
      </details>

      <!-- Outils -->
      <details class="accordion">
        <summary>Outils</summary>
        <div class="accordion__content">
          <button onclick="exportData()">Exporter les donn√©es (JSON)</button>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
          <button onclick="triggerImport()">Importer des donn√©es (JSON)</button>
          <button onclick="resetLoop()">R√©initialiser boucle</button>
          <button onclick="resetToday()" class="btnDanger">üóë Effacer les sessions du jour</button>
          <button onclick="purgeOrphans()">üßπ Purger sessions orphelines</button>
          <button onclick="debugState()">üîç Debug √©tat interne</button>
          <button onclick="copyLogs()">üìã Copier logs</button>
          <button onclick="resetAll()" class="btnDanger">üí£ Reset complet</button>

          <!-- Modale debug -->
          <div id="debugModal" class="debugModal hidden">
            <div class="debugModalInner">
              <div class="debugModalHeader">
                <span>√âtat interne</span>
                <button onclick="closeDebugModal()">‚úï</button>
              </div>
              <pre id="debugOutput" class="debugOutput"></pre>
              <button onclick="closeDebugModal()" class="debugModalClose">Fermer</button>
            </div>
          </div>
        </div>
      </details>
    </section>

  </main>

  <!-- Scripts ‚Äî order matters -->
  <script src="storage.js"></script>
  <script src="engine.js"></script>
  <script src="analytics.js"></script>
  <script src="events.store.js"></script>
  <script src="sessions.js"></script>
  <script src="import-export.js"></script>
  <script src="ui.js"></script>
  <script src="main.js"></script>
  <script>
    // D√©sinscrit tout Service Worker existant
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.getRegistrations().then(regs => {
        regs.forEach(reg => reg.unregister());
      });
    }
  </script>
</body>
</html>
